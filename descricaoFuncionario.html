<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>SchoolBank | Funcion√°rio</title>
    <link rel="stylesheet" href="EstilosCss/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Estilos espec√≠ficos para esta p√°gina */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal.hidden { display: none; }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 420px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-content label {
            display: block;
            margin-top: 12px;
            font-weight: 500;
            color: #333;
        }
        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin: 20px 0;
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #2c3e50;
        }
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            font-weight: 600;
        }

        /* Conte√∫do das tabs */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        .tab-content.active {
            display: block;
        }

        /* Grid de informa√ß√µes */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .info-item {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .info-item h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        .info-item p {
            margin: 5px 0;
            color: #555;
        }

        /* Status badge */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-ativo {
            background: #d5f4e6;
            color: #27ae60;
        }
        .status-inativo {
            background: #ffeaea;
            color: #e74c3c;
        }

        /* Bot√£o de a√ß√£o */
        .action-btn {
            margin: 20px 0;
        }

        /* Tabelas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        tr:hover {
            background: #f8f9fa;
        }

        /* Bot√µes pequenos */
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body>

<div class="app">

    <aside class="sidebar">
        <h2 class="logo">üè¶ SchoolBank</h2>
        <nav>
            <a href="index.html"><i class="fas fa-chart-bar"></i> Dashboard</a>
            <a class="active" href="alunos.html"><i class="fas fa-users"></i> Funcion√°rios</a>
            <a href="pagamentos.html"><i class="fas fa-money-bill-wave"></i> Pagamentos</a>
            <a href="holerite.html"><i class="fas fa-file-invoice"></i> Holerites</a>
            <a href="configuracao.html"><i class="fas fa-cog"></i> Configura√ß√µes</a>
        </nav>
    </aside>

    <main class="main">

        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <h1 id="tituloFuncionario">Detalhes do Funcion√°rio</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="voltar()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn" onclick="alternarStatus()" id="btnStatus">
                        <i class="fas fa-sync-alt"></i> Status
                    </button>
                </div>
            </div>
        </header>

        <!-- Tabs de navega√ß√£o -->
        <div class="tabs">
            <button class="tab active" data-tab="info">
                <i class="fas fa-info-circle"></i> Informa√ß√µes
            </button>
            <button class="tab" data-tab="boletim">
                <i class="fas fa-book"></i> Boletim
            </button>
        </div>

        <!-- ===== TAB: INFORMA√á√ïES ===== -->
        <div id="tab-info" class="tab-content active">
            
            <!-- Informa√ß√µes gerais -->
            <div class="info-grid">
                <div class="info-item">
                    <h3><i class="fas fa-id-card"></i> Dados Cadastrais</h3>
                    <p><strong>N√∫mero:</strong> <span id="numero"></span></p>
                    <p><strong>Nome:</strong> <span id="nome"></span></p>
                    <p><strong>Status:</strong> 
                        <span id="status" class="status-badge status-ativo"></span>
                    </p>
                    <p><strong>S√©rie:</strong> <span id="serie">-</span></p>
                    <p><strong>Data de Cadastro:</strong> <span id="dataCadastro">-</span></p>
                </div>

                <div class="info-item">
                    <h3><i class="fas fa-chart-line"></i> Estat√≠sticas</h3>
                    <p><strong>M√©dia Geral:</strong> <span id="mediaGeral">0,0</span></p>
                    <p><strong>Total de Disciplinas:</strong> <span id="totalDisciplinas">0</span></p>
                    <p><strong>√öltima Atualiza√ß√£o:</strong> <span id="ultimaAtualizacao">-</span></p>
                    <p><strong>Disciplinas com Nota:</strong> <span id="disciplinasComNota">0</span></p>
                </div>
            </div>

            <!-- Bot√£o para alternar status -->
            <div class="action-btn">
                <button class="btn" onclick="alternarStatus()" id="btnStatusAcao">
                    <i class="fas fa-sync-alt"></i> Alterar Status
                </button>
            </div>
        </div>

        <!-- ===== TAB: BOLETIM ===== -->
        <div id="tab-boletim" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-book"></i> Boletim Acad√™mico</h2>
                <button class="btn" onclick="abrirModalNota()">
                    <i class="fas fa-plus"></i> Lan√ßar Nota
                </button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Disciplina</th>
                        <th>1¬∫ Bim</th>
                        <th>2¬∫ Bim</th>
                        <th>3¬∫ Bim</th>
                        <th>4¬∫ Bim</th>
                        <th>M√©dia</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="listaBoletim"></tbody>
            </table>

            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <strong>Resumo:</strong>
                <span id="resumoBoletim">Carregando...</span>
            </div>
        </div>

    </main>
</div>

<!-- ===== MODAL PARA LAN√áAR NOTA ===== -->
<div id="modal-nota" class="modal hidden">
    <div class="modal-content">
        <h3><i class="fas fa-book"></i> Lan√ßar Nota</h3>

        <label>Disciplina</label>
        <select id="disciplina"></select>

        <label>Bimestre</label>
        <select id="bimestre">
            <option value="b1">1¬∫ Bimestre</option>
            <option value="b2">2¬∫ Bimestre</option>
            <option value="b3">3¬∫ Bimestre</option>
            <option value="b4">4¬∫ Bimestre</option>
        </select>

        <label>Nota (0-10)</label>
        <input type="number" id="nota" min="0" max="10" step="0.1" placeholder="Ex: 8.5">

        <div class="modal-actions">
            <button class="btn" onclick="fecharModalNota()">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button class="btn btn-success" onclick="salvarNota()">
                <i class="fas fa-save"></i> Salvar
            </button>
        </div>
    </div>
</div>

<script type="module">
    import { 
        db 
    } from "./firebase.js";
    
    import { 
        doc, getDoc, setDoc, updateDoc,
        collection, getDocs, increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    
    let funcionarioAtual = null;
    let estatisticas = {
        mediaGeral: 0,
        totalDisciplinas: 0,
        disciplinasComNota: 0
    };

    // ===== FUN√á√ïES PRINCIPAIS =====
    
    // FUN√á√ÉO PARA BUSCAR FUNCION√ÅRIO (substitua a importa√ß√£o que n√£o existe)
    async function buscarFuncionarioPorId(funcId) {
        try {
            if (!funcId) {
                console.error("ID do funcion√°rio n√£o fornecido");
                return null;
            }

            console.log("Buscando funcion√°rio com ID:", funcId);
            
            const docRef = doc(db, "funcionarios", funcId);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                console.log("Funcion√°rio encontrado:", data);
                return {
                    id: docSnap.id,
                    ...data
                };
            } else {
                console.error("Funcion√°rio n√£o encontrado no Firestore");
                return null;
            }
        } catch (error) {
            console.error("Erro ao buscar funcion√°rio:", error);
            return null;
        }
    }

    // FUN√á√ÉO PARA EDITAR FUNCION√ÅRIO
    async function editarFuncionario(funcId, novosDados) {
        try {
            const docRef = doc(db, "funcionarios", funcId);
            await updateDoc(docRef, {
                ...novosDados,
                atualizadoEm: new Date().toISOString()
            });
            return true;
        } catch (error) {
            console.error("Erro ao editar funcion√°rio:", error);
            return false;
        }
    }

    async function carregarFuncionario() {
        console.log("Iniciando carregamento do funcion√°rio, ID:", id);
        
        if (!id) {
            alert("ID do funcion√°rio n√£o informado na URL!");
            voltar();
            return;
        }

        funcionarioAtual = await buscarFuncionarioPorId(id);
        
        if (!funcionarioAtual) {
            alert("Funcion√°rio n√£o encontrado!");
            voltar();
            return;
        }

        console.log("Funcion√°rio carregado:", funcionarioAtual);

        // Atualizar interface da tab INFO
        document.getElementById('tituloFuncionario').textContent = funcionarioAtual.nome;
        document.getElementById('numero').textContent = funcionarioAtual.numero || 'N/A';
        document.getElementById('nome').textContent = funcionarioAtual.nome || 'N/A';
        document.getElementById('serie').textContent = funcionarioAtual.serieNome || '-';
        
        // Data de cadastro
        let dataCadastro = '-';
        if (funcionarioAtual.criadoEm) {
            try {
                const date = funcionarioAtual.criadoEm.toDate ? 
                    funcionarioAtual.criadoEm.toDate() : 
                    new Date(funcionarioAtual.criadoEm);
                dataCadastro = date.toLocaleDateString('pt-BR');
            } catch (e) {
                dataCadastro = '-';
            }
        }
        document.getElementById('dataCadastro').textContent = dataCadastro;
        
        // Status
        const status = funcionarioAtual.status || 'Ativo';
        const statusEl = document.getElementById('status');
        statusEl.textContent = status;
        statusEl.className = status === 'Inativo' ? 
            'status-badge status-inativo' : 'status-badge status-ativo';
        
        // Bot√£o de status
        const btnStatus = document.getElementById('btnStatus');
        const btnStatusAcao = document.getElementById('btnStatusAcao');
        const statusText = status === 'Inativo' ? 'Ativar' : 'Inativar';
        const statusIcon = status === 'Inativo' ? 'fa-check' : 'fa-ban';
        
        if (btnStatus) {
            btnStatus.innerHTML = `<i class="fas ${statusIcon}"></i> ${statusText}`;
        }
        
        if (btnStatusAcao) {
            btnStatusAcao.innerHTML = `<i class="fas ${statusIcon}"></i> ${statusText} Funcion√°rio`;
        }
        
        // Carregar boletim e estat√≠sticas
        await carregarBoletim();
        atualizarEstatisticasInfo();
    }

    async function carregarBoletim() {
        console.log("Carregando boletim para funcion√°rio:", id);
        
        const listaBoletim = document.getElementById("listaBoletim");
        const selectDisciplina = document.getElementById("disciplina");
        
        listaBoletim.innerHTML = "";
        selectDisciplina.innerHTML = "";

        // Resetar estat√≠sticas
        estatisticas.mediaGeral = 0;
        estatisticas.totalDisciplinas = 0;
        estatisticas.disciplinasComNota = 0;
        let totalNotas = 0;
        let qtdDisciplinasComNotas = 0;

        // Se n√£o tem s√©rie, n√£o carrega boletim
        if (!funcionarioAtual.serieId) {
            console.warn("Funcion√°rio sem s√©rie:", funcionarioAtual);
            listaBoletim.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #999; padding: 40px;">
                        <i class="fas fa-book fa-2x" style="margin-bottom: 10px;"></i><br>
                        Este funcion√°rio n√£o est√° associado a uma s√©rie.
                    </td>
                </tr>
            `;
            return;
        }

        console.log("Buscando s√©rie ID:", funcionarioAtual.serieId);

        try {
            // TENTAR DIFERENTES ESTRUTURAS DO FIREBASE
            let disciplinas = [];
            
            // Op√ß√£o 1: configuracoes/series/lista/{id}
            try {
                const serieRef1 = doc(db, "configuracoes", "series", "lista", funcionarioAtual.serieId);
                const serieSnap1 = await getDoc(serieRef1);
                
                if (serieSnap1.exists()) {
                    console.log("S√©rie encontrada na estrutura: configuracoes/series/lista/");
                    const serieData = serieSnap1.data();
                    disciplinas = serieData.disciplinas || [];
                } else {
                    // Op√ß√£o 2: series/{id}
                    const serieRef2 = doc(db, "series", funcionarioAtual.serieId);
                    const serieSnap2 = await getDoc(serieRef2);
                    
                    if (serieSnap2.exists()) {
                        console.log("S√©rie encontrada na estrutura: series/");
                        const serieData = serieSnap2.data();
                        disciplinas = serieData.disciplinas || [];
                    } else {
                        // Op√ß√£o 3: s√©ries direto no documento
                        const serieRef3 = doc(db, "series", funcionarioAtual.serieId);
                        const serieSnap3 = await getDoc(serieRef3);
                        
                        if (serieSnap3.exists()) {
                            console.log("S√©rie encontrada na estrutura direta");
                            const serieData = serieSnap3.data();
                            disciplinas = serieData.disciplinas || serieData.materias || [];
                        }
                    }
                }
            } catch (error) {
                console.error("Erro ao buscar s√©rie:", error);
            }

            estatisticas.totalDisciplinas = disciplinas.length;
            console.log("Disciplinas encontradas:", disciplinas);

            if (disciplinas.length === 0) {
                listaBoletim.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #999; padding: 40px;">
                            <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 10px;"></i><br>
                            Nenhuma disciplina cadastrada para esta s√©rie.
                        </td>
                    </tr>
                `;
                return;
            }

            for (const disciplina of disciplinas) {
                console.log("Processando disciplina:", disciplina);
                
                // Adicionar ao select
                selectDisciplina.innerHTML += 
                    `<option value="${disciplina}">${disciplina}</option>`;

                try {
                    // Buscar notas do funcion√°rio para esta disciplina
                    const ref = doc(db, "funcionarios", id, "boletim", disciplina);
                    const snap = await getDoc(ref);
                    const dados = snap.exists() ? snap.data() : {};

                    console.log(`Notas para ${disciplina}:`, dados);

                    // Calcular m√©dia da disciplina
                    const notas = [dados.b1, dados.b2, dados.b3, dados.b4]
                        .filter(n => n !== undefined && n !== null && !isNaN(n));
                    
                    const mediaDisciplina = notas.length > 0 ? 
                        (notas.reduce((a, b) => a + b, 0) / notas.length).toFixed(1) : "-";
                    
                    // Atualizar estat√≠sticas
                    if (notas.length > 0) {
                        estatisticas.disciplinasComNota++;
                        totalNotas += parseFloat(mediaDisciplina);
                        qtdDisciplinasComNotas++;
                    }

                    // Adicionar √† tabela
                    listaBoletim.innerHTML += `
                        <tr>
                            <td><strong>${disciplina}</strong></td>
                            <td>${dados.b1 !== undefined ? dados.b1 : "-"}</td>
                            <td>${dados.b2 !== undefined ? dados.b2 : "-"}</td>
                            <td>${dados.b3 !== undefined ? dados.b3 : "-"}</td>
                            <td>${dados.b4 !== undefined ? dados.b4 : "-"}</td>
                            <td><strong>${mediaDisciplina}</strong></td>
                            <td>
                                <button class="btn btn-small" onclick="editarNota('${disciplina}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                } catch (error) {
                    console.error(`Erro ao processar disciplina ${disciplina}:`, error);
                }
            }

            // Calcular m√©dia geral
            estatisticas.mediaGeral = qtdDisciplinasComNotas > 0 ? 
                (totalNotas / qtdDisciplinasComNotas).toFixed(1) : "0.0";

            // Atualizar resumo
            document.getElementById('resumoBoletim').innerHTML = `
                ${estatisticas.disciplinasComNota} de ${estatisticas.totalDisciplinas} disciplinas com notas | 
                M√©dia Geral: <strong>${estatisticas.mediaGeral}</strong>
            `;

        } catch (error) {
            console.error("Erro ao carregar boletim:", error);
            listaBoletim.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: #999; padding: 40px;">
                        <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 10px;"></i><br>
                        Erro ao carregar boletim: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    function atualizarEstatisticasInfo() {
        document.getElementById('mediaGeral').textContent = estatisticas.mediaGeral;
        document.getElementById('totalDisciplinas').textContent = estatisticas.totalDisciplinas;
        document.getElementById('disciplinasComNota').textContent = estatisticas.disciplinasComNota;
        document.getElementById('ultimaAtualizacao').textContent = new Date().toLocaleDateString('pt-BR');
    }

    // ===== FUN√á√ïES DE INTERFACE =====
    
    window.abrirTab = function(tabId) {
        console.log("Abrindo tab:", tabId);
        
        // Remover active de todas as tabs
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Adicionar active √† tab selecionada
        const tabButton = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if (tabButton) {
            tabButton.classList.add('active');
        }
        
        const tabContent = document.getElementById(`tab-${tabId}`);
        if (tabContent) {
            tabContent.classList.add('active');
        }
    }

    // ===== FUN√á√ïES DE MODAL =====
    
    window.abrirModalNota = function() {
        if (estatisticas.totalDisciplinas === 0) {
            alert("Este funcion√°rio n√£o tem disciplinas cadastradas na s√©rie.");
            return;
        }
        document.getElementById('modal-nota').classList.remove('hidden');
        document.getElementById('nota').focus();
    };

    window.fecharModalNota = function() {
        document.getElementById('modal-nota').classList.add('hidden');
        // Limpar campos
        document.getElementById('nota').value = '';
        document.getElementById('bimestre').value = 'b1';
    };

    window.editarNota = function(disciplina) {
        document.getElementById('disciplina').value = disciplina;
        abrirModalNota();
    };

    window.salvarNota = async function() {
        const disciplina = document.getElementById('disciplina').value;
        const bimestre = document.getElementById('bimestre').value;
        const nota = parseFloat(document.getElementById('nota').value);

        if (!disciplina || isNaN(nota) || nota < 0 || nota > 10) {
            alert('Preencha todos os campos corretamente! Nota deve ser entre 0 e 10.');
            return;
        }

        try {
            const ref = doc(db, "funcionarios", id, "boletim", disciplina);
            await setDoc(ref, {
                [bimestre]: nota,
                atualizadoEm: new Date().toISOString()
            }, { merge: true });

            fecharModalNota();
            await carregarBoletim();
            atualizarEstatisticasInfo();
            
            alert('Nota salva com sucesso!');
        } catch (error) {
            console.error('Erro ao salvar nota:', error);
            alert('Erro ao salvar nota.');
        }
    };

    // ===== FUN√á√ïES DE GERENCIAMENTO =====
    
    window.alternarStatus = async function() {
        const novoStatus = funcionarioAtual.status === 'Inativo' ? 'Ativo' : 'Inativo';
        const confirmar = confirm(`Deseja realmente ${novoStatus === 'Inativo' ? 'inativar' : 'ativar'} este funcion√°rio?`);
        
        if (confirmar) {
            try {
                await editarFuncionario(id, { 
                    status: novoStatus,
                    ativo: novoStatus === 'Ativo'
                });
                
                funcionarioAtual.status = novoStatus;
                await carregarFuncionario();
                
                alert(`Funcion√°rio ${novoStatus === 'Inativo' ? 'inativado' : 'ativado'} com sucesso!`);
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                alert('Erro ao alterar status.');
            }
        }
    };

    window.voltar = function() {
        window.location.href = "alunos.html";
    };

    // ===== INICIALIZA√á√ÉO =====
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOM carregado, iniciando carregamento...");
        
        // Mostrar ID na URL para debug
        console.log("ID da URL:", id);
        
        if (!id) {
            alert("ID do funcion√°rio n√£o encontrado na URL!");
            voltar();
            return;
        }
        
        await carregarFuncionario();
        
        // Adicionar event listeners para as tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabId = e.currentTarget.getAttribute('data-tab');
                abrirTab(tabId);
            });
        });
        
        // Para debug: verificar se o db est√° definido
        console.log("db definido?", !!db);
        console.log("Funcion√°rio carregado:", funcionarioAtual);
    });

    // Para debug: expor fun√ß√µes no console
    window.carregarFuncionario = carregarFuncionario;
    window.carregarBoletim = carregarBoletim;
</script>

</body>
</html>